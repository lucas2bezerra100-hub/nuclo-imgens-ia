<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Nuclo Imgens IA — Melhorar Qualidade de Foto</title>
  <meta name="description" content="Nuclo Imgens IA — ferramenta simples para melhorar qualidade de fotos com opção de IA (local ou via API)." />
  <style>
    :root{--bg:#0f1724;--card:#0b1220;--accent:#7c3aed;--muted:#9ca3af;--glass: rgba(255,255,255,0.04)}
    *{box-sizing:border-box}
    body{font-family:Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial; margin:0; background:linear-gradient(180deg,#071028 0%, #081325 60%); color:#e6eef8; min-height:100vh; display:flex; align-items:center; justify-content:center; padding:32px}
    .container{width:100%;max-width:1100px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border-radius:12px; padding:24px; box-shadow:0 8px 30px rgba(2,6,23,0.6);}
    header{display:flex;align-items:center;gap:16px;margin-bottom:18px}
    .logo{width:64px;height:64px;border-radius:12px;background:linear-gradient(135deg,var(--accent),#4338ca);display:flex;align-items:center;justify-content:center;font-weight:700;font-size:20px}
    h1{margin:0;font-size:20px}
    p.lead{margin:4px 0 0;color:var(--muted)}

    .grid{display:grid;grid-template-columns:1fr 420px;gap:18px}
    .card{background:var(--card); border-radius:10px;padding:16px;box-shadow:0 4px 18px rgba(2,6,23,0.6)}

    .uploader{display:flex;flex-direction:column;gap:12px}
    input[type=file]{display:block}
    .controls{display:flex;gap:8px;flex-wrap:wrap}
    button{background:var(--accent);border:none;padding:10px 14px;border-radius:8px;color:white;font-weight:600;cursor:pointer}
    button.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06)}
    .preview{display:flex;flex-direction:column;align-items:center;gap:10px}
    .preview img{max-width:100%;border-radius:8px;box-shadow:0 6px 20px rgba(2,6,23,0.6)}
    canvas{max-width:100%;border-radius:8px}
    footer.small{color:var(--muted);font-size:13px;margin-top:10px}

    @media (max-width:980px){.grid{grid-template-columns:1fr} .container{padding:16px}}

    .progress-container{width:100%;background:rgba(255,255,255,0.05);border-radius:6px;height:12px;margin-top:8px;overflow:hidden}
    .progress-bar{height:100%;width:0%;background:var(--accent);transition:width 0.2s}
  </style>
</head>
<body>
  <main class="container">
    <header>
      <div class="logo">Nú</div>
      <div>
        <h1>Nuclo Imgens IA — Melhorar Qualidade de Foto</h1>
        <p class="lead">Suba uma foto, veja a pré-visualização e experimente uma melhoria rápida (local ou via IA online).</p>
      </div>
    </header>

    <section class="grid">
      <section class="card">
        <div class="uploader">
          <label for="file">Escolha uma imagem (JPEG/PNG)</label>
          <input id="file" type="file" accept="image/*" />

          <div class="controls">
            <button id="btnImproveLocal">Melhorar (Local)</button>
            <button id="btnImproveApi" class="ghost">Melhorar (Via API)</button>
            <button id="btnDownload" class="ghost" disabled>Baixar imagem</button>
            <button id="btnReset" class="ghost">Limpar</button>
          </div>

          <div class="progress-container" style="display:none"><div class="progress-bar" id="progressBar"></div></div>
        </div>
      </section>

      <aside class="card">
        <div class="preview">
          <div id="placeholder">Nenhuma imagem carregada</div>
          <img id="previewImg" alt="preview" style="display:none"/>
          <canvas id="canvas" style="display:none"></canvas>
        </div>
        <div style="width:100%;margin-top:10px;color:var(--muted);font-size:13px">
          <strong>Nota:</strong> o botão "Melhorar (Local)" aplica upscaling simples + nitidez. O "Via API" envia para o backend Node/Express com IA.
        </div>
      </aside>
    </section>

  </main>

  <script>
    const fileInput = document.getElementById('file');
    const previewImg = document.getElementById('previewImg');
    const canvas = document.getElementById('canvas');
    const placeholder = document.getElementById('placeholder');
    const btnImproveLocal = document.getElementById('btnImproveLocal');
    const btnImproveApi = document.getElementById('btnImproveApi');
    const btnDownload = document.getElementById('btnDownload');
    const btnReset = document.getElementById('btnReset');
    const progressContainer = document.querySelector('.progress-container');
    const progressBar = document.getElementById('progressBar');

    let originalImage = null;

    fileInput.addEventListener('change', async (e)=>{
      const f = e.target.files && e.target.files[0];
      if(!f) return clearAll();
      const url = URL.createObjectURL(f);
      previewImg.src = url;
      previewImg.style.display = 'block';
      canvas.style.display = 'none';
      placeholder.style.display = 'none';
      originalImage = await loadImage(url);
      btnDownload.disabled = false;
    });

    function loadImage(src){
      return new Promise((res, rej)=>{
        const img = new Image();
        img.onload = ()=>res(img);
        img.onerror = rej;
        img.src = src;
      })
    }

    function clearAll(){
      previewImg.src = '';
      previewImg.style.display = 'none';
      canvas.style.display = 'none';
      placeholder.style.display = 'block';
      btnDownload.disabled = true;
      fileInput.value = '';
      originalImage = null;
      progressContainer.style.display = 'none';
      progressBar.style.width = '0%';
    }

    btnReset.addEventListener('click', clearAll);

    btnImproveLocal.addEventListener('click', ()=>{
      if(!originalImage) return alert('Carregue uma imagem primeiro.');
      const factor = 2;
      const w = originalImage.width * factor;
      const h = originalImage.height * factor;
      canvas.width = w;
      canvas.height = h;
      canvas.style.display = 'block';
      const ctx = canvas.getContext('2d');
      ctx.imageSmoothingEnabled = true;
      ctx.imageSmoothingQuality = 'high';
      ctx.drawImage(originalImage, 0, 0, w, h);
      const imageData = ctx.getImageData(0,0,w,h);
      const sharpened = convolveSharpen(imageData);
      ctx.putImageData(sharpened,0,0);
      previewImg.style.display = 'none';
    });

    btnImproveApi.addEventListener('click', async ()=>{
      if(!originalImage) return alert('Carregue uma imagem primeiro.');
      progressContainer.style.display = 'block';
      progressBar.style.width = '10%';

      const tempCanvas = document.createElement('canvas');
      tempCanvas.width = originalImage.width;
      tempCanvas.height = originalImage.height;
      const tctx = tempCanvas.getContext('2d');
      tctx.drawImage(originalImage,0,0);

      tempCanvas.toBlob(async (blob)=>{
        if(!blob) return alert('Erro ao ler imagem');
        try{
          btnImproveApi.innerText = 'Enviando...';
          const form = new FormData();
          form.append('image', blob, 'upload.png');

          const res = await fetch('/api/enhance', { method:'POST', body: form });
          if(!res.ok) throw new Error('Resposta do servidor: ' + res.status);
          const resBlob = await res.blob();
          const url = URL.createObjectURL(resBlob);
          const img = await loadImage(url);
          canvas.width = img.width;
          canvas.height = img.height;
          canvas.style.display = 'block';
          const ctx = canvas.getContext('2d');
          ctx.drawImage(img,0,0);
          previewImg.style.display = 'none';
          progressBar.style.width = '100%';
        }catch(err){
          alert('Falha no envio para a API. ' + err.message);
          progressBar.style.width = '0%';
        }finally{
          btnImproveApi.innerText = 'Melhorar (Via API)';
        }
      }, 'image/png');
    });

    btnDownload.addEventListener('click', ()=>{
      const a = document.createElement('a');
      if(canvas.style.display !== 'none'){
        a.href = canvas.toDataURL('image/png');
        a.download = 'nuclo-enhanced.png';
      } else if(previewImg.src){
        a.href = previewImg.src;
        a.download = 'nuclo-original.png';
      } else return;
      a.click();
    });

    function convolveSharpen(imageData){
      const w = imageData.width; const h = imageData.height;
      const src = imageData.data; const dst = new Uint8ClampedArray(src.length);
      const kernel = [ 0, -1, 0, -1, 5, -1, 0, -1, 0 ];
      const ksize = 3; const half = 1;
      for(let y=0;y<h;y++){
        for(let x=0;x<w;x++){
          let r=0,g=0,b=0;
          for(let ky=-half; ky<=half; ky++){
            for(let kx=-half; kx<=half; kx++){
              const ix = Math.min(w-1, Math.max(0, x+kx));
              const iy = Math.min(h-1, Math.max(0, y+ky));
              const i = (iy*w + ix) * 4;
              const kval = kernel[(ky+half)*ksize + (kx+half)];
              r += src[i] * kval;
              g += src[i+1] * kval;
              b += src[i+2] * kval;
            }
          }
          const di = (y*w + x)*4;
          dst[di] = clamp(r);
          dst[di+1] = clamp(g);
          dst[di+2] = clamp(b);
          dst[di+3] = src[di+3];
        }
      }
      return new ImageData(dst, w, h);
    }
    function clamp(v){ return Math.max(0, Math.min(255, Math.round(v))); }
  </script>
</body>
</html>
